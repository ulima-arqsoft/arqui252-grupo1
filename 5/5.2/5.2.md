> [5. Tácticas](../5.md) › [5.2. Módulo 2 / Compras](5.2.md)

# 5.2. Módulo 2 — Compras

---

## Decisión 1 — Rendimiento en listados y búsquedas (OC/SC)

### Escenario
| Cod Escenario | Atributo de Calidad | Estímulo                                                           | Fuente del Estímulo        | Artefacto                       | Entorno                                   | Respuesta                                                                 | Medida de Respuesta |
|---|---|---|---|---|---|---|---|
| **ESC-02** | Rendimiento | Múltiples usuarios acceden simultáneamente a listados y búsquedas de OC/SC | Usuarios internos/externos | Listados y buscadores de OC/SC | Carga alta (≥ 100 usuarios concurrentes) | Paginación en servidor, índices por campos clave, filtros incrementales y caché de lecturas frecuentes | **p95 < 2 s** en listados/búsquedas; **CPU BD < 70%** |

### Táctica Elegida
**Optimización de consultas + paginación en servidor + caché selectiva.**  
Se agregan índices en `fecha`, `proveedor` y `estado`, se usa **keyset/limit-offset** según el caso, **ETag** para respuestas y **caché** de consultas frecuentes con invalidación al crear/actualizar.

### Documentación de la Decisión (ADR)
- **Título:** Optimizar listados de Compras con **paginación servidor + índices + caché**.
- **Contexto:** Los usuarios de compras y dirección consultan OC/SC intensamente en horas pico; sin optimización, los tiempos de respuesta superan el umbral aceptable.
- **Alternativas:**
  - *Solo paginación en cliente* (no reduce carga en BD).
  - *Materialized view para todo* (más mantenimiento).
  - **Paginación servidor + índices + caché** (equilibrio simple/efectivo).
- **Criterios de Elección:** Impacto en p95, facilidad de implementación, bajo costo operativo, bajo riesgo.
- **Decisión:** Implementar **paginación servidor**, **índices** y **caché** con invalidación.
- **Sustento:** Es la vía más simple para bajar latencia sostenidamente sin complejidad extra (no requiere cambios de arquitectura).

---

## Decisión 2 — Interoperabilidad Compras ↔ Inventario (sincronía de stock)

### Escenario
| Cod Escenario | Atributo de Calidad | Estímulo                                     | Fuente del Estímulo | Artefacto                    | Entorno         | Respuesta                                                                                                  | Medida de Respuesta |
|---|---|---|---|---|---|---|---|
| **ESC-13** | Interoperabilidad | Actualizar stock automáticamente al recepcionar/completar OC | Sistema externo (Inventario) | API de Compras ↔ Inventario | Operación normal | **Contratos REST estables**, **Transactional Outbox**, **idempotencia** por `idempotency-key` y **reintentos** con backoff | **≥ 99%** de transacciones sin desincronización; **duplicados = 0** |

### Táctica Elegida
**Patrón anticorrupción + Transactional Outbox + Idempotencia.**  
Compras registra eventos en *outbox* al confirmar recepciones/OC; un worker publica a Inventario. Se deduplica con `idempotency-key`.

### Documentación de la Decisión (ADR)
- **Título:** Integración robusta Compras–Inventario con **Outbox + Idempotencia**.
- **Contexto:** La consistencia del stock depende de las recepciones confirmadas en Compras; fallos transitorios no deben generar pérdidas o duplicados.
- **Alternativas:**
  - *Llamado directo sin reintentos* (frágil ante caídas).
  - *Eventos sin transacción local* (riesgo de “mensaje fantasma”).
  - **Outbox transaccional + reintentos + idempotencia**.
- **Criterios de Elección:** Consistencia, tolerancia a fallos, simplicidad operativa.
- **Decisión:** Adoptar **Outbox** con **publicación confiable**, reintentos y **idempotencia** en el receptor.
- **Sustento:** Patrón estándar, bajo esfuerzo y alta efectividad para integraciones críticas.

---

## Decisión 3 — Usabilidad en operación diaria (SC/OC/Recepciones)

### Escenario
| Cod Escenario | Atributo de Calidad | Estímulo                                       | Fuente del Estímulo           | Artefacto                              | Entorno          | Respuesta                                                                 | Medida de Respuesta |
|---|---|---|---|---|---|---|---|
| **ESC-06** | Usabilidad | Revisión/registro frecuente de SC/OC/Recepciones | Usuarios de compras/almacén | Interfaces CRUD y buscadores de Compras | Operación normal | **Filtros rápidos**, **vistas guardadas por usuario**, validación en línea y mensajes claros | **≥ 90%** de operaciones completadas al primer intento |

### Táctica Elegida
**Modelo de tareas + vistas guardadas + validación en línea.**  
La UI guía el flujo (SC→OC→Recepción), permite guardar filtros personales y valida errores antes de enviar.

### Documentación de la Decisión (ADR)
- **Título:** Mejoras de **usabilidad** con **vistas guardadas** y **validación guiada** en Compras.
- **Contexto:** Los operadores repiten las mismas consultas/acciones; necesitan rapidez y menos errores de digitación.
- **Alternativas:**
  - *Lista plana sin filtros persistentes*.
  - **Filtros rápidos + vistas guardadas + validación en línea**.
- **Criterios de Elección:** Reducción de retrabajo, tiempo de operación, aprendizaje mínimo.
- **Decisión:** Implementar **vistas guardadas** por usuario, filtros rápidos y validaciones contextuales.
- **Sustento:** Cambios pequeños con alto impacto en eficiencia y calidad de datos.

---

## Decisión 4 — Importación masiva de ítems a OC (CSV)

### Escenario
| Cod Escenario | Atributo de Calidad | Estímulo                                          | Fuente del Estímulo   | Artefacto                    | Entorno         | Respuesta                                                                                                         | Medida de Respuesta |
|---|---|---|---|---|---|---|---|
| **ESC-05** | Interoperabilidad / Disponibilidad | Importar lista masiva de ítems a una OC desde CSV | Usuario administrativo | Módulo de Órdenes de Compra | Operación normal | **Validación de esquema** y **previsualización**; procesamiento **en background** con **staging table** y **DLQ** para errores | **100%** de filas válidas importadas; errores detallados por fila; **UI no bloqueada** |

### Táctica Elegida
**Validación previa + staging + procesamiento en background.**  
Se valida encabezado y tipos antes de cargar; se inserta en *staging* y un job promueve registros válidos; errores van a DLQ con detalle.

### Documentación de la Decisión (ADR)
- **Título:** Importación CSV confiable con **previsualización + staging + job en background**.
- **Contexto:** Las áreas envían listados extensos; bloquear la UI o insertar datos inválidos impacta disponibilidad e integridad.
- **Alternativas:**
  - *Carga directa y síncrona* (bloquea UI y arriesga errores en lote).
  - **Prevalidación + background + staging + DLQ**.
- **Criterios de Elección:** Calidad de datos, experiencia de usuario, resiliencia.
- **Decisión:** Implementar flujo **asíncrono** con **previsualización** y **promoción** controlada.
- **Sustento:** Asegura datos correctos, evita bloqueos y facilita auditoría de errores por fila.

---
