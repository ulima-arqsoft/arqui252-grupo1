> [0. Acerca del Grupo](../../0.md) ‚Ä∫ [0.6. Temas Individuales (Parte 1)](../0.6.md) ‚Ä∫ [0.6.2. Integrante 2](0.6.2.md)

# 0.6.2. Integrante 2

# CI/CD b√°sico con GitHub Actions + Docker

---

## Desarrollo conceptual

### ¬øQu√© es y por qu√© importa en DevOps?
**Integraci√≥n Continua (CI)** integra cambios frecuentemente en la rama principal y ejecuta compilaciones y pruebas autom√°ticas para detectar fallas temprano.  
**Entrega/Despliegue Continuo (CD)** automatiza el empaquetado y la entrega del software hacia entornos de ejecuci√≥n, reduciendo fricci√≥n y tiempos de salida.

### Relaci√≥n con atributos de calidad
- **Disponibilidad**: al evitar pasos manuales en el _build_ y empaquetado, disminuyen errores humanos y potenciales ca√≠das.  
- **Mantenibilidad**: el proceso est√° codificado en YAML y Dockerfile, lo que permite revisi√≥n por PR y evoluci√≥n controlada.  
- **Testabilidad**: las pruebas corren por defecto en cada cambio; el dise√±o del servicio prioriza endpoints _testables_ (p. ej., `/health`).  
- **Confiabilidad**: el uso de contenedores garantiza el mismo artefacto en todos los entornos.  
- **Seguridad**: se integraron _secrets_ de GitHub para configurar credenciales sin exponerlas en el repositorio.  
- **Portabilidad**: Docker encapsula dependencias y asegura un comportamiento consistente entre local y CI.

---

## Consideraciones t√©cnicas

### Herramientas elegidas y por qu√©
- **GitHub Actions**: CI/CD integrado al repositorio, con _runners_ administrados y acciones reutilizables.  
- **Docker**: empaquetado reproducible del servicio; evita configuraciones fr√°giles en hosts.  
- **Docker Compose (local)**: facilita levantar la app para validaci√≥n y demo.  
- **Node.js + Jest**: _stack_ simple para ilustrar pruebas automatizadas; f√°cilmente reemplazable por otros lenguajes.

> El enfoque es **agn√≥stico de proveedor**: todo corre en local y en CI sin requerir servicios _cloud_ espec√≠ficos.

### Configuraci√≥n paso a paso (comandos, archivos clave, variables)

#### 0) Prerrequisitos
- Git git --version
- Node.js 20 node -v (>= 20.x)
- npm npm -v
- Docker Desktop (o Docker Engine + Compose)
  - docker --version
  - docker compose version
- Cuenta de GitHub (para el repo y Actions)
- Editor (VS Code recomendado)

#### 1) Estructura y dependencias
```bash
# Crear estructura base
mkdir devops-ci-docker && cd devops-ci-docker
mkdir -p api/src api/__tests__ .github/workflows

# Inicializar ejemplo Node
cd api
npm init -y
npm install express
npm install -D jest supertest
```

**`api/src/index.js`**
```js
const express = require("express");
const app = express();

const PORT = process.env.PORT || 3000;
const API_BASE_URL = process.env.API_BASE_URL || "https://example.local.pruebavideo";

app.get("/health", (_req, res) => {
  res.json({ ok: true, ts: Date.now(), apiBase: API_BASE_URL });
});

if (require.main === module) {
  app.listen(PORT, () => console.log(`API up on :${PORT}`));
}

module.exports = app;
```

**`api/__tests__/health.test.js`**
```js
const request = require("supertest");
const app = require("../src/index");

describe("health endpoint", () => {
  test("responde ok", async () => {
    const res = await request(app).get("/health");
    expect(res.status).toBe(200);
    expect(res.body.ok).toBe(true);
  });
});

```

**`api/package.json`**
```json
{
  "name": "api",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node src/index.js",
    "test": "jest --passWithNoTests"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "express": "^5.1.0"
  },
  "devDependencies": {
    "jest": "^30.2.0",
    "supertest": "^7.1.4"
  }
}
```

#### 2) Contenerizaci√≥n
**`api/Dockerfile`**
```dockerfile
FROM node:20-alpine AS base
WORKDIR /app
COPY package*.json ./
RUN npm ci --omit=dev
COPY . .
EXPOSE 3000
ENV NODE_ENV=production
CMD ["npm","start"]
```

#### 3) Orquestaci√≥n local para la demo
**`docker-compose.yml`** (en la ra√≠z)
```yaml
services:
  api:
    build: ./api
    environment:
      - API_BASE_URL=${API_BASE_URL:-https://example.local}
    ports:
      - "3000:3000"
```

**Ejecuci√≥n local**
```bash
# Construir y levantar
API_BASE_URL=https://api.demo.local docker compose up --build -d
# Verificaci√≥n
curl -s http://localhost:3000/health | jq
```

#### 4) Pipeline de CI/CD (GitHub Actions)
> El pipeline se ejecuta en `push` y `pull_request`

**`.github/workflows/ci.yml`**
```yaml
name: CI
on:
  push:
  pull_request:
permissions:
  contents: read
jobs:
  build-test:
    runs-on: ubuntu-latest
    env:
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci
        working-directory: api

      - name: Run tests
        run: npm test -- --ci
        working-directory: api

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: ./api
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/mini-api:latest
          build-args: |
            API_BASE_URL=${{ env.API_BASE_URL }}

      - name: Trigger deploy in Render
        run: curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
```

> **Secrets utilizados:** `API_BASE_URL`, `DOCKERHUB_USERNAME`, `DOCKERHUB_TOKEN`, `RENDER_DEPLOY_HOOK_URL`. Estos secretos permiten configurar el build, autenticarse en Docker Hub, y desplegar autom√°ticamente en Render. Se agregan desde **Settings ‚Üí Secrets and variables ‚Üí Actions** del repositorio y est√°n protegidos contra exposici√≥n en logs.

#### 5) Evidencias y validaci√≥n
- **Ejecuci√≥n local**: `/health` responde `200` con `{ ok: true, apiBase: "‚Ä¶" }`.  
- **CI en GitHub**: se observan las etapas `Install deps`, `Run tests`, `Build image` y `Deploy` con _status_ **verde**.  
- **Trazabilidad**: cada _run_ est√° asociado a su _commit SHA_; el pipeline se ejecuta para PR y _push_.
- **Render**: se confirma el redeploy autom√°tico desde la imagen en Docker Hub.
- **Demo en video**: https://drive.google.com/file/d/1TL7kVNgipADWxm_beaftVhPVpOmjj94e/view?usp=sharing

---

### Buenas pr√°cticas aplicadas
- **Fail-fast**: pruebas antes de la construcci√≥n de imagen.  
- **Artefacto reproducible**: imagen Docker generada de forma consistente en CI y local.  
- **Seguridad**: secretos gestionados por GitHub; sin credenciales en el repositorio.  
- **Observabilidad**: _logs_ detallados por etapa; salida de pruebas visible en el _run_.  
- **Pipeline como c√≥digo**: todo el flujo est√° versionado en `.github/workflows/ci.yml`.

---

## Navegaci√≥n del entregable
[‚¨ÖÔ∏è Anterior](../0.6.2/0.6.2.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../0.6.4/0.6.4.md)