> [0. Acerca del Grupo](../../0.md) ‚Ä∫ [0.7. Trabajo Individual (Patrones Cloud)](../0.7.md) ‚Ä∫ [0.7.3. Integrante 3](0.7.3.md)

# 0.7.3. Integrante 3

## Federated Identity
---

## ¬øQu√© es?

Es un modelo en el cual la autenticaci√≥n se delega a un **proveedor de identidad externo (IdP)**. En lugar de que la aplicaci√≥n gestione directamente las credenciales del usuario, conf√≠a en ese proveedor para verificar su identidad, lo que simplifica el desarrollo, reduce la administraci√≥n de usuarios y evita el manejo directo de contrase√±as dentro de la aplicaci√≥n.

## contexto y problema 

Los usuarios suelen trabajar con varias aplicaciones de distintas organizaciones, lo que implica manejar m√∫ltiples credenciales. Esto provoca diversos problemas:

- **Credenciales diferentes:** genera una mala experiencia de uso, ya que es com√∫n olvidar contrase√±as.

- **Riesgos de seguridad:** algunas cuentas pueden permanecer activas cuando un usuario deja la empresa.

- **Mayor carga administrativa:** debido a la constante gesti√≥n y recuperaci√≥n de credenciales.

En consecuencia, los usuarios prefieren utilizar una sola identidad para evitar estos inconvenientes.

## Soluci√≥n 

La soluci√≥n consiste en implementar un mecanismo de autenticaci√≥n basado en el patr√≥n Federated Identity, separando la autenticaci√≥n del c√≥digo de la aplicaci√≥n y deleg√°ndola a un proveedor de **identidad de confianza (IdP)**. Este enfoque simplifica el desarrollo, reduce la carga administrativa y permite que los usuarios se autentiquen mediante distintos proveedores de identidad, manteniendo adem√°s una separaci√≥n clara entre autenticaci√≥n y autorizaci√≥n.

Su funci√≥n es autenticar al usuario y emitir **tokens** de seguridad que contienen informaci√≥n sobre su identidad y, opcionalmente, sus roles o permisos.

En la siguiente imagen, se muestra c√≥mo una aplicaci√≥n cliente solicita acceso a un servicio protegido. En lugar de autenticarse directamente con dicho servicio, la aplicaci√≥n redirige la autenticaci√≥n al IdP (en conjunto con el STS). El IdP valida las credenciales y devuelve un token de seguridad, el cual la aplicaci√≥n usa para acceder al servicio. De esta manera, el servicio conf√≠a en la autenticaci√≥n emitida por el proveedor y no necesita gestionar credenciales propias.

![Ejemplo](./images/EjemploPatron.png)

## Casos de Aplicaci√≥n:

Este patr√≥n puede aplicarse en distintos contextos y tipos de organizaciones. Algunos casos representativos incluyen:

- En **empresas y entornos corporativos**, es com√∫n que los empleados utilicen m√∫ltiples aplicaciones internas como ERP, CRM, intranet, correo corporativo o sistemas de recursos humanos. Para evitar que cada sistema gestione credenciales de manera independiente, la organizaci√≥n puede implementar identidad federada mediante un proveedor corporativo como Azure AD, ADFS o Keycloak. De esta forma, la autenticaci√≥n se centraliza y los usuarios inician sesi√≥n una sola vez con su cuenta institucional, mientras que las aplicaciones conf√≠an en el IdP sin almacenar ni validar contrase√±as por separado.

- En **aplicaciones B2C y startups** que ofrecen login, como Uber, Spotify, Airbnb o apps m√≥viles emergentes, la identidad federada permite delegar la autenticaci√≥n a proveedores conocidos como Google, Apple o Facebook. Esta estrategia agiliza el registro y acceso, ya que el usuario no necesita crear nuevas credenciales, lo que mejora la experiencia, reduce el abandono al registrarse y minimiza los problemas de recuperaci√≥n de contrase√±as.

- En las **plataformas educativas de universidades y sistemas e-learning**, es habitual que estudiantes y docentes utilicen m√∫ltiples servicios digitales, como bibliotecas virtuales, el correo institucional, la intranet o herramientas externas como Google Workspace y Zoom. Para unificar el acceso, estas instituciones suelen implementar identidad federada y centralizar la autenticaci√≥n mediante un IdP institucional. Esto permite administrar usuarios de manera centralizada y aplicar pol√≠ticas coherentes a toda la comunidad acad√©mica, facilitando tanto el acceso como la seguridad. Adem√°s, cuando un alumno egresa o un docente deja la instituci√≥n, su cuenta puede desactivarse autom√°ticamente en todos los servicios, simplificando la gesti√≥n y evitando accesos indebidos.

## Aplicaci√≥n en el proyecto grupal

En el **M√≥dulo 3: Gesti√≥n de Usuarios y Seguridad** se implementar√° el patr√≥n Federated Identity espec√≠ficamente para el manejo de **usuarios externos**. Este patr√≥n permitir√° que dichos usuarios se autentiquen a trav√©s de proveedores de identidad externos como **Auth0**, evitando que el sistema gestione directamente sus credenciales y reduciendo la exposici√≥n de datos sensibles.

Por otro lado, los **usuarios internos** continuar√°n autentic√°ndose mediante el mecanismo interno del ERP cl√≠nico. Esta separaci√≥n mantiene la flexibilidad y control interno sobre el acceso del personal, sin comprometer la integraci√≥n con servicios externos.

## Desarrollo de C√≥digo y Demo

La siguiente estructura muestra c√≥mo se organiza la demo **auth0-login-demo**, siguiendo una arquitectura por capas (Dominio, Aplicaci√≥n, Infraestructura y Presentaci√≥n).

```bash
auth0-login-demo
‚îú‚îÄ‚îÄ src
‚îÇ   ‚îú‚îÄ‚îÄ aplicacion
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.service.js         # casos de uso
‚îÇ   ‚îú‚îÄ‚îÄ dominio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.entity.js          # Entidades
‚îÇ   ‚îú‚îÄ‚îÄ infraestructura
        ‚îî‚îÄ‚îÄ auth
            ‚îî‚îÄ‚îÄ auth.config.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.js               # entrada servidor / config Auth0
‚îÇ   ‚îî‚îÄ‚îÄ presentacion
‚îÇ       ‚îú‚îÄ‚îÄ controladores
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ auth.controller.js  # controladores HTTP
‚îÇ       ‚îî‚îÄ‚îÄ rutas
‚îÇ           ‚îî‚îÄ‚îÄ auth.routes.js      # rutas de autenticaci√≥n
‚îú‚îÄ‚îÄ .env                            # variables de entorno
‚îú‚îÄ‚îÄ Dockerfile                      # imagen Docker
‚îú‚îÄ‚îÄ package.json                    # dependencias y scripts
```
--- 

### Requisitos Previos

- Node.js v18+
- Docker
- Cuenta en Auth0

---

### Codigo fuente 

En las siguientes secciones se detallan los archivos que conforman la demo, junto con el c√≥digo implementado en cada uno de ellos.


### .env
El archivo **.env** contiene las variables de entorno para configurar la autenticaci√≥n con Auth0 y definir el puerto donde se ejecuta la aplicaci√≥n.
```bash
PORT=3000
AUTH0_SECRET=1p+nEQdYLM48/LiPBmUDvZ9T7YqPMgBhw2H+pzunME8=
AUTH0_BASE_URL=http://localhost:3000
AUTH0_ISSUER_BASE_URL=https://dev-ia383ich31x40flc.us.auth0.com
AUTH0_CLIENT_ID=2oaCbFgzzugjrTelfmF5E4LjNr95BSuz
AUTH0_CLIENT_SECRET=Z8GP-2zPsn8GQwaXq6ZaL5PILdmSbz1wwf2X77sz93-BOQ38AGJMLBc3nZ0rFzUU
```

### auth.service.js

Este archivo pertenece a la capa de **aplicaci√≥n**. Su funci√≥n principal es transformar los datos del usuario autenticado por Auth0 en una entidad del dominio (User), que luego puede ser utilizada por otras capas del sistema.

```bash
import { User } from "../dominio/user.entity.js";

export class AuthService {
  static getUserInfo(oidcUser) {
    if (!oidcUser) return null;
    return new User({ name: oidcUser.name, email: oidcUser.email });
  }
}
```

### user.entity.js

Este archivo pertenece a la capa de **dominio** y define la entidad principal del proceso de autenticaci√≥n, el cual es usuario. 
```bash
export class User {
  constructor({ name, email }) {
    this.name = name;
    this.email = email;
  }
}

```

### auth.config.js

Forma parte de la capa de **infraestructura** y define la configuraci√≥n de autenticaci√≥n con Auth0.
Su funci√≥n es centralizar las credenciales y par√°metros necesarios para conectar la aplicaci√≥n con el proveedor de identidad Auth0.

```bash
import { auth } from "express-openid-connect";
import dotenv from "dotenv";

dotenv.config();

export const authConfig = {
  authRequired: false,
  auth0Logout: true,
  secret: process.env.AUTH0_SECRET,
  baseURL: process.env.AUTH0_BASE_URL,
  clientID: process.env.AUTH0_CLIENT_ID,
  issuerBaseURL: process.env.AUTH0_ISSUER_BASE_URL,
};

export const authMiddleware = auth(authConfig);

```

**server.js**
Este archivo es el punto de entrada principal del servidor y pertenece **infraestructura**.
Su funci√≥n es inicializar la aplicaci√≥n Express, configurar el middleware de autenticaci√≥n de Auth0 y registrar las rutas definidas en la capa de presentaci√≥n.

```bash
import express from "express";
import { authMiddleware } from "./auth/auth.config.js";
import authRoutes from "../presentacion/rutas/auth.routes.js";
import dotenv from "dotenv";

dotenv.config();

const app = express();

// Middleware de autenticaci√≥n Auth0
app.use(authMiddleware);

// Rutas
app.use("/", authRoutes);

// Inicio del servidor
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Servidor en marcha en ${process.env.AUTH0_BASE_URL}`);
});

```
## auth.controller.js

Este pertenece a la capa de **presentaci√≥n**.
Su prop√≥sito es manejar las solicitudes HTTP relacionadas con la autenticaci√≥n, interactuando con la capa de aplicaci√≥n para obtener la informaci√≥n del usuario autenticado y mostrar lo necesario en la interfaz.

```bash
import { AuthService } from "../../aplicacion/auth.service.js";

export class AuthController {
  static home(req, res) {
    const user = AuthService.getUserInfo(req.oidc.user);

    res.send(`
      <h1>Bienvenido a la demo Auth0</h1>
      ${req.oidc.isAuthenticated()
        ? `<p>Hola, ${user.name}</p><p><a href="/logout">Cerrar sesi√≥n</a></p>`
        : `<p><a href="/login">Iniciar sesi√≥n</a></p>`}
    `);
  }
}

```

### auth.routes.js

Pertenece a la capa de **presentaci√≥n**.
Su funci√≥n es definir las rutas HTTP relacionadas con la autenticaci√≥n y vincularlas con los controladores correspondientes.

```bash
import express from "express";
import { AuthController } from "../controladores/auth.controller.js";

const router = express.Router();

router.get("/", AuthController.home);

export default router;

```

### Dockerfile
Este archivo define la imagen Docker para levantar el proyecto, con el se crea el contenedor para ejecutar la aplicaci√≥n Node.js con Auth0.

```bash
# Imagen base
FROM node:18

# Crear directorio de trabajo dentro del contenedor
WORKDIR /app

# Copiar los archivos del proyecto
COPY package*.json ./
RUN npm install

COPY . .

# Exponer puerto
EXPOSE 3000

# Comando de arranque
CMD ["npm", "start"]
```
### package.json
Este archivo define las dependencias, los scripts de ejecuci√≥n y la configuraci√≥n b√°sica del proyecto Node.js.

```bash
{
  "type": "module",
  "name": "auth0-login-demo",
  "version": "1.0.0",
  "description": "",
  "scripts": {
    "start": "node src/infraestructura/server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "dotenv": "^17.2.3",
    "express": "^5.1.0",
    "express-openid-connect": "^2.19.2"
  }
}
```

---

## Demo

Se detalla a continuaci√≥n la secuencia de pasos necesaria para la ejecuci√≥n de la demo:

### Ejecutar la demo

1. Clonar el repositorio:
```bash
git clone [URL]
```

2. Navegar hasta la carpeta del proyecto (esta carpeta):
```bash
cd [carpeta]
```

3. Levantar todos los servicios con Docker Compose:
```bash
docker compose up
```

4. Ingresar a la pagina web en:
```bash
http://localhost:3000
```

5. Presionar el bot√≥n ‚ÄúIniciar sesi√≥n‚Äù.

![Pagina principal](./images/paginaprincipal.png)

6. Autenticarse utilizando alguna de las opciones que ofrece Auth0.

![auth0](./images/auth0.png)

7. Al iniciar sesi√≥n correctamente, se muestra la pantalla principal con el nombre del perfil del usuario autenticado.

![NobrePerfil](./images/nombrePerfil.png)









---

[‚¨ÖÔ∏è Anterior](../0.7.2/0.7.2.md) | [üè† Home](../../../README.md) | [Siguiente ‚û°Ô∏è](../0.7.4/0.7.4.md)