> [0. Acerca del Grupo](../../0.md) â€º [0.7. Trabajo Individual (Patrones Cloud)](../0.7.md) â€º [0.7.4. Integrante 4](0.7.4.md)

# 0.7.4. Integrante 4

# PatrÃ³n Cloud: Scheduler Agent Supervisor

## Â¿QuÃ© es?

El patrÃ³n Scheduler-Agent-Supervisor es un patrÃ³n de arquitectura distribuida que coordina tareas asÃ­ncronas mediante tres componentes principales:

- **Scheduler (Programador):** Programa y desencadena tareas en intervalos especÃ­ficos o eventos determinados.
- **Agent (Agente):** Ejecuta tareas especÃ­ficas de forma independiente y especializada.
- **Supervisor:** Monitorea la ejecuciÃ³n de los agents, maneja fallos, implementa lÃ³gica de reintentos y garantiza la confiabilidad del sistema.

Este patrÃ³n es ideal para sistemas que requieren **automatizaciÃ³n confiable**, **tolerancia a fallos** y **procesamiento asÃ­ncrono** de tareas recurrentes sin intervenciÃ³n manual.

---

## Contexto y Problema

En sistemas empresariales como ERP, especialmente en el control de inventarios, existen mÃºltiples tareas repetitivas y crÃ­ticas que deben ejecutarse de forma automÃ¡tica y confiable:

- **Tareas manuales propensas a errores:** La revisiÃ³n manual de niveles de stock, generaciÃ³n de reportes y alertas consume tiempo y puede olvidarse.
- **Falta de respuesta inmediata:** Los problemas como stock bajo o productos vencidos no se detectan hasta que es demasiado tarde.
- **Procesos sin tolerancia a fallos:** Si una tarea falla (por ejemplo, conexiÃ³n a base de datos perdida), el proceso se detiene completamente sin reintentos.
- **Escalabilidad limitada:** Agregar nuevas tareas automatizadas requiere modificar el cÃ³digo central de la aplicaciÃ³n.
- **Falta de visibilidad:** No existe un registro centralizado de quÃ© tareas se ejecutaron, cuÃ¡les fallaron y por quÃ©.

En consecuencia, los administradores necesitan un sistema que ejecute tareas automÃ¡ticamente, se recupere de fallos y proporcione visibilidad completa del estado de las operaciones.

---

## SoluciÃ³n

La soluciÃ³n consiste en implementar el patrÃ³n **Scheduler-Agent-Supervisor** que separa las responsabilidades en tres capas:

### 1. **Scheduler (Programador)**
- Programa tareas usando expresiones cron o eventos especÃ­ficos
- Define **cuÃ¡ndo** se ejecutan las tareas
- Coordina la invocaciÃ³n de mÃºltiples agents
- No contiene lÃ³gica de negocio

### 2. **Agents (Agentes)**
- Ejecutan tareas especÃ­ficas de forma independiente
- Cada agent estÃ¡ especializado en **una responsabilidad** (principio de responsabilidad Ãºnica)
- Son stateless (sin estado) y pueden ejecutarse en paralelo
- Reportan su estado al Supervisor

### 3. **Supervisor**
- Monitorea la salud de todos los agents
- Implementa lÃ³gica de **reintentos automÃ¡ticos** cuando un agent falla
- Registra logs centralizados de todas las ejecuciones
- Puede activar/desactivar agents dinÃ¡micamente
- Proporciona mÃ©tricas y estadÃ­sticas en tiempo real

### Flujo de EjecuciÃ³n
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Scheduler   â”‚ â† Programa tareas cada X tiempo
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ desencadena
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supervisor  â”‚ â† Coordina y monitorea
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ejecuta
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Agent     â”‚ â† Ejecuta tarea especÃ­fica
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ reporta estado
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supervisor  â”‚ â† Registra resultado, maneja fallos
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Este enfoque garantiza que:
- Las tareas se ejecuten automÃ¡ticamente sin intervenciÃ³n manual
- El sistema se recupere automÃ¡ticamente de fallos temporales
- Exista visibilidad completa de todas las operaciones
- Nuevas tareas puedan agregarse sin modificar el cÃ³digo existente

---

## Casos de AplicaciÃ³n

Este patrÃ³n puede aplicarse en diversos contextos empresariales y tÃ©cnicos:

### 1. **Sistemas de Control de Inventario (ERP)**
En sistemas de gestiÃ³n de inventario mÃ©dico o retail, es crucial mantener niveles Ã³ptimos de stock. El patrÃ³n permite:
- **Agent de Stock:** Revisa automÃ¡ticamente productos con stock bajo y genera Ã³rdenes de compra
- **Agent de Vencimiento:** Detecta productos prÃ³ximos a vencer y envÃ­a alertas
- **Agent de Reportes:** Genera reportes diarios de movimientos, rotaciÃ³n y valor del inventario
- **Supervisor:** Garantiza que si la base de datos falla temporalmente, las tareas se reintenten automÃ¡ticamente

### 2. **Procesamiento de Pagos y FacturaciÃ³n**
Plataformas como Netflix, Spotify o servicios SaaS necesitan procesar pagos recurrentes de forma confiable:
- **Agent de FacturaciÃ³n:** Genera facturas mensuales automÃ¡ticamente
- **Agent de Cobro:** Intenta procesar pagos con reintentos en caso de fallo
- **Agent de Notificaciones:** EnvÃ­a recordatorios de pagos pendientes
- **Supervisor:** Maneja fallos de gateways de pago y reintenta hasta 3 veces antes de marcar como fallido

### 3. **Pipelines de Datos y ETL**
Empresas como Airbnb, Uber o plataformas de analytics necesitan procesar grandes volÃºmenes de datos periÃ³dicamente:
- **Agent de ExtracciÃ³n:** Extrae datos de mÃºltiples fuentes cada hora
- **Agent de TransformaciÃ³n:** Limpia y transforma datos
- **Agent de Carga:** Carga datos procesados a data warehouses
- **Supervisor:** Monitorea el pipeline completo y reinicia pasos especÃ­ficos si fallan

### 4. **Monitoreo de Infraestructura**
Herramientas como Datadog, New Relic o sistemas de DevOps necesitan verificar la salud de servicios continuamente:
- **Agent de Health Check:** Verifica el estado de microservicios cada minuto
- **Agent de MÃ©tricas:** Recolecta CPU, memoria y mÃ©tricas de red
- **Agent de Alertas:** EnvÃ­a notificaciones cuando se detectan anomalÃ­as
- **Supervisor:** Garantiza que si un agent de monitoreo falla, otro tome su lugar

---

## AplicaciÃ³n en el Proyecto - Modulo 4 de Inventario MÃ©dico

En el sistema de **Control de Inventario MÃ©dico**, se implementÃ³ el patrÃ³n Scheduler-Agent-Supervisor para automatizar tareas crÃ­ticas del mÃ³dulo de inventario.

### Arquitectura Implementada
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SCHEDULER (node-cron)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Tarea 1: Cada 1 minuto          â”‚   â”‚
â”‚  â”‚ Tarea 2: Cada 2 minutos         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ desencadena
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SUPERVISOR                    â”‚
â”‚  â€¢ Monitorea 2 agents activos           â”‚
â”‚  â€¢ Reintentos: mÃ¡ximo 3 intentos        â”‚
â”‚  â€¢ Registra logs en SQLite              â”‚
â”‚  â€¢ Proporciona mÃ©tricas en tiempo real  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ ejecuta y monitorea
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AGENTS                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  StockCheckAgent               â”‚    â”‚
â”‚  â”‚  â€¢ Revisa stock bajo           â”‚    â”‚
â”‚  â”‚  â€¢ Genera Ã³rdenes automÃ¡ticas  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ReportAgent                   â”‚    â”‚
â”‚  â”‚  â€¢ Genera reportes diarios     â”‚    â”‚
â”‚  â”‚  â€¢ Calcula mÃ©tricas            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Componentes Implementados

**1. Scheduler:**
- Programa la revisiÃ³n de stock cada 1 minuto (configurable)
- Programa la generaciÃ³n de reportes cada 2 minutos
- Utiliza expresiones cron estÃ¡ndar
- Puede iniciar/detener tareas dinÃ¡micamente

**2. Agents:**

**StockCheckAgent:**
- Consulta productos con stock menor al mÃ­nimo establecido
- Calcula cantidad Ã³ptima a pedir: `(min_stock Ã— 2) - stock_actual`
- Genera Ã³rdenes de compra automÃ¡ticamente en la base de datos
- Registra cada ejecuciÃ³n con timestamp y resultado

**ReportAgent:**
- Genera reporte de inventario con mÃ©tricas clave:
  - Total de productos y unidades
  - Valor total del inventario
  - Productos crÃ­ticos (stock bajo)
  - Movimientos del dÃ­a
  - Ã“rdenes de compra pendientes
- Almacena reportes para auditorÃ­a

**3. Supervisor:**
- Monitorea el estado (activo/inactivo) de cada agent
- Implementa reintentos exponenciales: 5s â†’ 10s â†’ 20s
- Registra logs en tabla `task_logs` con:
  - Nombre del agent
  - Estado (SUCCESS/ERROR/RUNNING)
  - Mensaje descriptivo
  - Tiempo de ejecuciÃ³n
- Actualiza `last_heartbeat` de cada agent
- Proporciona estadÃ­sticas:
  - Total de ejecuciones
  - Tasa de Ã©xito/fallo
  - Tiempo promedio de ejecuciÃ³n
- Dashboard en tiempo real accesible vÃ­a API REST

## Desarrollo de CÃ³digo y Demo

La siguiente estructura muestra cÃ³mo se organiza el proyecto **mini-erp-scheduler**, siguiendo separaciÃ³n de responsabilidades:
```bash
erp-demo/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ agents/                    # Agents especializados
â”‚   â”‚   â”‚   â”œâ”€â”€ StockCheckAgent.js     # Agent revisiÃ³n stock
â”‚   â”‚   â”‚   â””â”€â”€ ReportAgent.js         # Agent generaciÃ³n reportes
â”‚   â”‚   â”œâ”€â”€ scheduler/                 # PatrÃ³n
â”‚   â”‚   â”‚   â”œâ”€â”€ Scheduler.js           # Programador de tareas
â”‚   â”‚   â”‚   â””â”€â”€ Supervisor.js          # Monitoreo y reintentos
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â””â”€â”€ database.js            # ConfiguraciÃ³n SQLite
â”‚   â”‚   â””â”€â”€ server.js                  # Servidor Express + API REST
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ inventory.db               # Base de datos SQLite
â”‚   â”œâ”€â”€ package.json                   # Dependencias Node.js
â”‚   â””â”€â”€ .env                           # Variables de entorno
â””â”€â”€ frontend/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ components/
    â”‚   â”‚   â””â”€â”€ Dashboard.jsx          # UI completo (inventario + supervisor)
    â”‚   â”œâ”€â”€ App.jsx                    # AplicaciÃ³n React
    â”‚   â””â”€â”€ main.jsx                   # Entry point
    â”œâ”€â”€ package.json                   # Dependencias React
    â””â”€â”€ vite.config.js                 # ConfiguraciÃ³n Vite
```

### Stack TecnolÃ³gico

**Backend:**
- **Node.js + Express:** Servidor API REST
- **better-sqlite3:** Base de datos SQLite embebida
- **node-cron:** Scheduler con expresiones cron
- **dotenv:** Variables de entorno

**Frontend:**
- **React + Vite:** Interfaz de usuario moderna y reactiva
- **Axios:** Cliente HTTP para consumir API
- **Tailwind CSS:** Estilos utility-first
- **Lucide React:** Iconos

**Base de Datos:**
- **SQLite:** Base de datos embebida (ideal para demo)
- Tablas: `products`, `purchase_orders`, `stock_movements`, `task_logs`, `agent_status`

---

## Requisitos Previos

- **Node.js** v18 o superior
- **npm** o **yarn**
- **Git** (opcional)
- **Navegador web** moderno (Chrome, Firefox, Edge)

---

## Demo

Se detalla a continuaciÃ³n la secuencia de pasos necesaria para la ejecuciÃ³n de la demo:

### Paso 1: Clonar el repositorio
```bash
git clone [URL del repositorio]
cd mini-erp-scheduler
```

### Paso 2: Instalar dependencias del Backend
```bash
cd backend
npm install
```

### Paso 3: Configurar variables de entorno (Opcional)

Editar el archivo `backend/.env` para ajustar intervalos:
```env
PORT=3000
DB_PATH=./database/inventory.db

# Intervalos (formato cron)
STOCK_CHECK_INTERVAL=*/1 * * * *  # Cada 1 minuto
REPORT_INTERVAL=*/2 * * * *       # Cada 2 minutos
```

### Paso 4: Iniciar el servidor Backend
```bash
npm run dev
```

**Salida esperada:**
```
ğŸ“Š Inicializando base de datos...
ğŸ“¦ Insertando productos de ejemplo...
ğŸ¤– Registrando agents...
âœ… Base de datos inicializada correctamente

ğŸ¯ Inicializando patrÃ³n Scheduler-Agent-Supervisor...
ğŸ¤– [Supervisor] Registrando agent: StockCheckAgent
ğŸ¤– [Supervisor] Registrando agent: ReportAgent
ğŸ“… [Scheduler] Programando tarea: RevisiÃ³n de Stock (*/1 * * * *)
ğŸ“… [Scheduler] Programando tarea: GeneraciÃ³n de Reportes (*/2 * * * *)

ğŸš€ [Scheduler] Iniciando scheduler...
   âœ… RevisiÃ³n de Stock activada (*/1 * * * *)
   âœ… GeneraciÃ³n de Reportes activada (*/2 * * * *)

ğŸš€ Servidor ejecutÃ¡ndose en http://localhost:3000
ğŸ“Š API disponible en http://localhost:3000/api
âœ¨ PatrÃ³n Scheduler-Agent-Supervisor activo
```

### Paso 5: Instalar dependencias del Frontend

**Abrir una nueva terminal** y ejecutar:
```bash
cd frontend
npm install
```

### Paso 6: Iniciar la aplicaciÃ³n Frontend
```bash
npm run dev
```

**Salida esperada:**
```
VITE v5.0.8  ready in 450 ms

âœ  Local:   http://localhost:5173/
âœ  Network: use --host to expose
```

### Paso 7: Acceder a la aplicaciÃ³n

Abrir el navegador en: **http://localhost:5173**

---

[â¬…ï¸ Anterior](../0.7.3/0.7.3.md) | [ğŸ  Home](../../../README.md) | [Siguiente â¡ï¸](../0.7.5/0.7.5.md)