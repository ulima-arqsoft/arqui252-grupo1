> [0. Acerca del Grupo](../../0.md) â€º [0.8. Temas Individuales (Parte 2)](../0.8.md) â€º [0.8.1. Integrante 1](0.8.1.md)

# 0.8.1. Integrante 1

# Arquitectura Hexagonal en Aplicaciones Empresariales

## 1. Desarrollo conceptual 

### Â¿QuÃ© es la arquitectura hexagonal?

La **arquitectura hexagonal** (tambiÃ©n conocida como **Ports & Adapters**) es un estilo de arquitectura que organiza una aplicaciÃ³n alrededor de su dominio de negocio, aislÃ¡ndolo de los detalles tÃ©cnicos como frameworks web, bases de datos, colas de mensajes o servicios externos.

En lugar de acoplar el dominio directamente a HTTP, JPA o cualquier tecnologÃ­a especÃ­fica, la arquitectura hexagonal propone:

- Un **nÃºcleo de dominio** independiente (entidades, lÃ³gica de negocio, casos de uso).
- **Puertos (ports)**: interfaces que definen cÃ³mo el dominio se comunica con el exterior:
  - **Puertos de entrada (driving ports)**: casos de uso expuestos.
  - **Puertos de salida (driven ports)**: lo que el dominio necesita de infra (repositorios, servicios externos).
- **Adaptadores (adapters)**: implementaciones concretas de esos puertos para tecnologÃ­as especÃ­ficas:
  - Adaptadores de entrada: controllers REST, CLI, eventos, etc.
  - Adaptadores de salida: repositorios JPA, clientes HTTP, colas, etc.

La regla clave es que **todas las dependencias apuntan hacia el dominio**, nunca al revÃ©s.

---

### Â¿Por quÃ© se necesita?

En un sistema tradicional en capas mal aplicado, es comÃºn que:

- El dominio se contamine con anotaciones de framework (`@Entity`, `@RestController`, etc.).
- Los servicios de negocio dependan directamente de `JpaRepository`, `HttpServletRequest`, DTOs de infraestructura, etc.
- Cambiar la base de datos o el framework web implique tocar muchas capas.

Esto genera problemas como:

- **Dificultad para probar** la lÃ³gica sin levantar todo el entorno (servidor, DB, etc.).
- **Alto acoplamiento** a tecnologÃ­as que se vuelven difÃ­ciles de reemplazar.
- Mezcla de **reglas de negocio** con detalles tÃ©cnicos.

La arquitectura hexagonal aborda estos problemas al imponer una separaciÃ³n explÃ­cita entre:

- **QuÃ© hace** el sistema (dominio y casos de uso).
- **CÃ³mo se expone y persiste** (HTTP, DB, colas, etc.).

---

### Capacidades principales

En lugar de que el dominio â€œsepaâ€ cÃ³mo hablar con HTTP o con la base de datos, la arquitectura hexagonal permite:

**1. Independencia de frameworks e infraestructura**

El dominio no depende de Spring, JPA, drivers de base de datos, ni SDKs externos.  
Si maÃ±ana cambia el framework web (por ejemplo, de Spring MVC a WebFlux, o a otro framework), los cambios se concentran en los adaptadores, no en el nÃºcleo.

---

**2. MÃºltiples adaptadores de entrada para los mismos casos de uso**

El mismo caso de uso (`ScheduleAppointmentUseCase`) puede ser invocado desde:

- Un **REST Controller** (HTTP).
- Una **CLI** (lÃ­nea de comandos).
- Un **consumidor de mensajes** (RabbitMQ, Kafka).
- Un **job programado** (cron).

Todos usan el mismo puerto de entrada, evitando duplicar lÃ³gica.

---

**3. MÃºltiples adaptadores de salida intercambiables**

Un mismo puerto de salida (`AppointmentRepositoryPort`) puede tener varias implementaciones:

- Un repositorio **JPA / PostgreSQL** para producciÃ³n.
- Un repositorio **en memoria** para pruebas.
- Un repositorio **MongoDB** para otro contexto.

Cambiar de una a otra solo requiere modificar el wiring de beans, sin tocar la lÃ³gica de negocio.

---

**4. Testeabilidad del dominio**

Al trabajar contra interfaces (puertos), los casos de uso pueden ser probados con:

- **Mocks o stubs** de repositorios.
- Sin levantar servidor HTTP.
- Sin necesidad de una base de datos real.

Esto reduce el costo de pruebas y facilita TDD o pruebas unitarias aisladas.

---

**5. EvoluciÃ³n y mantenimiento a largo plazo**

Al tener el dominio aislado, los cambios de reglas de negocio no dependen de decisiones tomadas aÃ±os atrÃ¡s sobre:

- El ORM elegido.
- El proveedor cloud.
- El estilo de API (REST, gRPC, eventos).

Esto hace al sistema mÃ¡s **evolutivo y mantenible**.

---

### Ventajas

La arquitectura hexagonal ofrece ventajas importantes en el contexto de aplicaciones empresariales:

- **Bajo acoplamiento** entre dominio e infraestructura.
- **Alta cohesiÃ³n** del nÃºcleo de negocio.
- **Flexibilidad tecnolÃ³gica** (swap de frameworks, DB, buses).
- **Facilidad para agregar nuevas interfaces de usuario** (web, mÃ³vil, CLI, bots).
- **Pruebas mÃ¡s simples y rÃ¡pidas** al no depender del entorno completo.

En el contexto de este trabajo, se aplica arquitectura hexagonal para construir un mÃ³dulo de **gestiÃ³n de citas mÃ©dicas** en **Spring Boot**, manteniendo el dominio clÃ­nico independiente de Spring, JPA y PostgreSQL.

---

### Diagrama conceptual

A nivel conceptual, la aplicaciÃ³n se puede visualizar como un hexÃ¡gono:

- En el centro: **dominio y casos de uso**.
- En los lados: **puertos de entrada** y **puertos de salida**.
- Alrededor: **adaptadores** conectados a HTTP y a la base de datos.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ADAPTADORES DE ENTRADA                            â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ PatientControllerâ”‚  â”‚AppointmentControlâ”‚  â”‚ MetricsControllerâ”‚           â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚           â”‚
â”‚  â”‚  POST /patients  â”‚  â”‚ POST /appoints   â”‚  â”‚  GET /metrics    â”‚           â”‚
â”‚  â”‚                  â”‚  â”‚ GET /appoints    â”‚  â”‚                  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                     â”‚
            â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PUERTOS DE ENTRADA (in)                            â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚RegisterPatientUseâ”‚  â”‚ScheduleAppoint   â”‚  â”‚ListAppointments  â”‚           â”‚
â”‚  â”‚     Case         â”‚  â”‚    UseCase       â”‚  â”‚   UseCase        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                      â”‚
â”‚           â”‚          â”‚ CancelAppoint    â”‚            â”‚                      â”‚
â”‚           â”‚          â”‚   UseCase        â”‚            â”‚                      â”‚
â”‚           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                  â”‚                      â”‚
            â–¼                  â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CAPA DE APLICACIÃ“N (Services)                        â”‚
â”‚                              @Timed @Cacheable                              â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚RegisterPatient   â”‚  â”‚ScheduleAppoint   â”‚  â”‚ListAppointments  â”‚           â”‚
â”‚  â”‚   Service        â”‚  â”‚   Service        â”‚  â”‚   Service        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â”‚           â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                      â”‚
â”‚           â”‚          â”‚ CancelAppoint    â”‚            â”‚                      â”‚
â”‚           â”‚          â”‚   Service        â”‚            â”‚                      â”‚
â”‚           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                      â”‚
â”‚           â”‚                   â”‚                      â”‚                      â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                               â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            DOMINIO (Core)                                   â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                   â”‚   LÃ³gica de Negocio     â”‚                              â”‚
â”‚                   â”‚                         â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Patient  â”‚â”€â”€â”€â”€â–¶â”‚  â”‚  Appointment   â”‚     â”‚     â”‚Appointmentâ”‚            â”‚
â”‚  â”‚          â”‚     â”‚  â”‚                â”‚     â”‚     â”‚  Status   â”‚             â”‚
â”‚  â”‚ -id      â”‚     â”‚  â”‚ -id            â”‚     â”‚â—€â”€â”€â”€â”€â”‚           â”‚            â”‚
â”‚  â”‚ -name    â”‚     â”‚  â”‚ -patient       â”‚     â”‚     â”‚ SCHEDULED â”‚           â”‚
â”‚  â”‚ -documentâ”‚     â”‚  â”‚ -scheduledAt   â”‚     â”‚     â”‚ CANCELLED â”‚           â”‚
â”‚  â”‚ -email   â”‚     â”‚  â”‚ -status        â”‚     â”‚     â”‚ COMPLETED â”‚           â”‚
â”‚  â”‚ -phone   â”‚     â”‚  â”‚ -reason        â”‚     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚                â”‚     â”‚                             â”‚
â”‚                    â”‚  â”‚ cancel()       â”‚     â”‚                             â”‚
â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PUERTOS DE SALIDA (out)                             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚PatientRepositoryPort     â”‚      â”‚AppointmentRepositoryPort â”‚           â”‚
â”‚  â”‚                          â”‚      â”‚                          â”‚           â”‚
â”‚  â”‚ + findById()             â”‚      â”‚ + findById()             â”‚           â”‚
â”‚  â”‚ + findByDocumentNumber() â”‚      â”‚ + findAll()              â”‚           â”‚
â”‚  â”‚ + save()                 â”‚      â”‚ + findByPatientId()      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ + findAllPaged()         â”‚           â”‚
â”‚               â”‚                    â”‚ + save()                 â”‚           â”‚
â”‚               â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                                 â”‚
                â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ADAPTADORES DE SALIDA                                â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚PatientRepositoryAdapter  â”‚      â”‚AppointmentRepositoryAdaptâ”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚               â”‚                                  â”‚                         â”‚
â”‚               â–¼                                  â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚SpringDataPatientRepo     â”‚      â”‚SpringDataAppointmentRepo â”‚           â”‚
â”‚  â”‚  (JpaRepository)         â”‚      â”‚  (JpaRepository)         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚               â”‚                                  â”‚                         â”‚
â”‚               â–¼                                  â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ PatientJpaEntity         â”‚      â”‚ AppointmentJpaEntity     â”‚           â”‚
â”‚  â”‚ (@Entity)                â”‚      â”‚ (@Entity)                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         INFRAESTRUCTURA                                     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ PostgreSQL  â”‚  â”‚ HikariCP     â”‚  â”‚ Actuator   â”‚  â”‚ Prometheus  â”‚      â”‚
â”‚  â”‚   Database  â”‚  â”‚ Pool (10)    â”‚  â”‚ /health    â”‚  â”‚ Metrics     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ Spring      â”‚  â”‚ Micrometer   â”‚  â”‚ Cache      â”‚                        â”‚
â”‚  â”‚ Boot 3.4    â”‚  â”‚ @Timed       â”‚  â”‚ Manager    â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**DescripciÃ³n del flujo:**
1. El **controlador REST** (adaptador de entrada) recibe las peticiones HTTP.
2. El controlador invoca los **casos de uso** (puertos de entrada).
3. Los casos de uso ejecutan la **lÃ³gica de negocio** en el dominio.
4. El dominio utiliza **puertos de salida** para acceder a la persistencia.
5. Los **adaptadores de persistencia** implementan los puertos usando JPA/PostgreSQL.

**CaracterÃ­sticas de observabilidad:**
- **@Timed** en servicios para mÃ©tricas de rendimiento
- **@Cacheable** en consultas para optimizaciÃ³n
- **HikariCP** para pool de conexiones eficiente
- **Actuator + Prometheus** para monitoreo en tiempo real

---

## 2. Consideraciones tÃ©cnicas

Para este proyecto, las consideraciones tÃ©cnicas se centran en el uso de:

### 1. Spring Boot como framework de aplicaciÃ³n

Se utiliza **Spring Boot** para:

- Levantar el servidor HTTP (REST).
- Configurar los beans y el wiring entre puertos y adaptadores.
- Integrar **Spring Data JPA** con PostgreSQL como adaptador de persistencia.

Spring actÃºa como **capa externa** (infraestructura), mientras el dominio permanece libre de anotaciones de framework.

---

### 2. Java 21 como lenguaje principal

Se emplea **Java 21** por:

- Soporte de caracterÃ­sticas modernas del lenguaje.
- Compatibilidad con Spring Boot 3.x.
- Uso extendido en entornos empresariales.

Las clases del dominio se mantienen simples (POJOs), lo que refuerza la independencia del nÃºcleo de negocio.

---

### 3. Lombok para reducir cÃ³digo boilerplate

Se utiliza **Lombok** para:

- Generar automÃ¡ticamente getters, setters, constructores y builders.
- Reducir el cÃ³digo repetitivo en DTOs y entidades.
- Mejorar la legibilidad del cÃ³digo.

---

### 4. Spring Boot Actuator para monitoreo

Se integra **Spring Boot Actuator** para:

- Exponer endpoints de salud (`/actuator/health`).
- Monitorear el estado de la aplicaciÃ³n y base de datos.
- Facilitar la observabilidad en entornos de producciÃ³n.

---

### 5. PostgreSQL y JPA como capa de persistencia

A nivel de base de datos relacional, se define un modelo mÃ­nimo para el dominio clÃ­nico:

**Tabla `patient`**

```sql
CREATE TABLE patient (
    id              BIGSERIAL PRIMARY KEY,
    document_number VARCHAR(20) NOT NULL UNIQUE,
    full_name       VARCHAR(150) NOT NULL,
    email           VARCHAR(120),
    phone           VARCHAR(30),
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);
```

**Tabla `appointment`**

```sql
CREATE TABLE appointment (
    id            BIGSERIAL PRIMARY KEY,
    patient_id    BIGINT NOT NULL REFERENCES patient(id),
    scheduled_at  TIMESTAMP NOT NULL,
    status        VARCHAR(20) NOT NULL,  -- SCHEDULED / CANCELLED / COMPLETED
    reason        VARCHAR(255),
    created_at    TIMESTAMP NOT NULL DEFAULT NOW()
);
```

Estas tablas son accedidas desde el dominio a travÃ©s de puertos de salida, implementados por adaptadores basados en Spring Data JPA.

### 6. OrganizaciÃ³n de paquetes (estructura hexagonal)

La estructura lÃ³gica del proyecto sigue una clara separaciÃ³n:

```
com.example.clinic
  â”œâ”€â”€ ClinicApplication.java
  â”œâ”€â”€ domain
  â”‚     â”œâ”€â”€ model
  â”‚     â”‚     â”œâ”€â”€ Patient.java
  â”‚     â”‚     â”œâ”€â”€ Appointment.java
  â”‚     â”‚     â””â”€â”€ AppointmentStatus.java
  â”‚     â””â”€â”€ port
  â”‚           â””â”€â”€ out
  â”‚                 â”œâ”€â”€ PatientRepositoryPort.java
  â”‚                 â””â”€â”€ AppointmentRepositoryPort.java
  â”‚
  â”œâ”€â”€ application
  â”‚     â”œâ”€â”€ dto
  â”‚     â”‚     â”œâ”€â”€ PatientDto.java
  â”‚     â”‚     â”œâ”€â”€ AppointmentDto.java
  â”‚     â”‚     â””â”€â”€ AppointmentPageDto.java
  â”‚     â”œâ”€â”€ command
  â”‚     â”‚     â”œâ”€â”€ RegisterPatientCommand.java
  â”‚     â”‚     â””â”€â”€ ScheduleAppointmentCommand.java
  â”‚     â”œâ”€â”€ port
  â”‚     â”‚     â””â”€â”€ in
  â”‚     â”‚           â”œâ”€â”€ RegisterPatientUseCase.java
  â”‚     â”‚           â”œâ”€â”€ ScheduleAppointmentUseCase.java
  â”‚     â”‚           â”œâ”€â”€ ListAppointmentsUseCase.java
  â”‚     â”‚           â””â”€â”€ CancelAppointmentUseCase.java
  â”‚     â””â”€â”€ service
  â”‚           â”œâ”€â”€ RegisterPatientService.java
  â”‚           â”œâ”€â”€ ScheduleAppointmentService.java
  â”‚           â”œâ”€â”€ ListAppointmentsService.java
  â”‚           â””â”€â”€ CancelAppointmentService.java
  â”‚
  â”œâ”€â”€ adapters
  â”‚     â”œâ”€â”€ in
  â”‚     â”‚     â””â”€â”€ web
  â”‚     â”‚           â”œâ”€â”€ PatientController.java
  â”‚     â”‚           â””â”€â”€ AppointmentController.java
  â”‚     â””â”€â”€ out
  â”‚           â””â”€â”€ persistence
  â”‚                 â”œâ”€â”€ entity
  â”‚                 â”‚     â”œâ”€â”€ PatientJpaEntity.java
  â”‚                 â”‚     â””â”€â”€ AppointmentJpaEntity.java
  â”‚                 â”œâ”€â”€ SpringDataPatientRepository.java
  â”‚                 â”œâ”€â”€ SpringDataAppointmentRepository.java
  â”‚                 â”œâ”€â”€ PatientRepositoryAdapter.java
  â”‚                 â””â”€â”€ AppointmentRepositoryAdapter.java
  â”‚
  â””â”€â”€ config
        â”œâ”€â”€ BeanConfig.java
        â””â”€â”€ DatabaseHealthIndicator.java

```

**Requisitos previos**

- JDK 21 instalado.
- PostgreSQL en ejecuciÃ³n (local o contenedor).
- Maven para construir el proyecto.
- IDE compatible (IntelliJ, Eclipse, VS Code) o lÃ­nea de comandos.

---

## 3. Demo

La demo implementada muestra cÃ³mo aplicar arquitectura hexagonal en un mÃ³dulo sencillo de gestiÃ³n de citas mÃ©dicas usando Spring Boot, PostgreSQL y JPA.

**Funcionalidades:**

- Registrar pacientes.
- Agendar citas para un paciente.
- Listar citas (todas o por paciente, con paginaciÃ³n).
- Cancelar citas.

Todo ello manteniendo el dominio desacoplado de la infraestructura.

---

### CÃ³mo ejecutar la demo

**1. Configurar la base de datos PostgreSQL**

Crear la base de datos y las tablas `patient` y `appointment` usando los scripts SQL mencionados anteriormente.

**2. Configurar las credenciales de la base de datos**

Editar el archivo `src/main/resources/application.yaml`:

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/clinic_db
    username: clinic_user
    password: clinic_password
```

**3. Construir y ejecutar el proyecto**

```bash
mvn clean install
mvn spring-boot:run
```

**4. Probar la API**

Usar herramientas como Postman, cURL o el archivo `prueba.http` incluido en el proyecto:

- `POST /api/patients` - Registrar pacientes.
- `POST /api/appointments` - Agendar citas.
- `GET /api/appointments` - Listar todas las citas (soporta paginaciÃ³n con `?page=0&size=10`).
- `GET /api/appointments?patientId={id}` - Listar citas de un paciente especÃ­fico.
- `PATCH /api/appointments/{id}/cancel` - Cancelar una cita.

**5. Verificar el estado de la aplicaciÃ³n**

El endpoint de Actuator estÃ¡ disponible en:

- `GET /actuator/health` - Estado de salud de la aplicaciÃ³n y base de datos.

---

## 4. Observabilidad: Disponibilidad y Rendimiento

La aplicaciÃ³n implementa caracterÃ­sticas avanzadas de observabilidad para evidenciar **disponibilidad** y **rendimiento**.

### Disponibilidad

**Health Checks personalizados:**

- **Endpoint principal:** `GET /actuator/health`
  - Verifica el estado general de la aplicaciÃ³n (UP/DOWN)
  - Muestra informaciÃ³n detallada de la base de datos:
    - VersiÃ³n de PostgreSQL
    - Driver JDBC utilizado
    - URL de conexiÃ³n
    - Estado del pool de conexiones (HikariCP)
  - Detecta automÃ¡ticamente si la base de datos estÃ¡ disponible

**Ejemplo de respuesta:**
```json
{
  "status": "UP",
  "components": {
    "db": {
      "status": "UP",
      "details": {
        "database": "PostgreSQL",
        "version": "16.x",
        "driver": "PostgreSQL JDBC Driver",
        "url": "jdbc:postgresql://localhost:5432/clinic_db",
        "connection_pool": "HikariCP Active",
        "status": "Connected"
      }
    }
  }
}
```

---

### Rendimiento

**1. Pool de conexiones optimizado (HikariCP)**

ConfiguraciÃ³n en `application.yaml`:
- **maximum-pool-size:** 10 conexiones simultÃ¡neas
- **minimum-idle:** 5 conexiones mÃ­nimas en espera
- **connection-timeout:** 30 segundos
- **idle-timeout:** 10 minutos
- **max-lifetime:** 30 minutos

**2. CachÃ© en consultas frecuentes**

El servicio `ListAppointmentsService` implementa cachÃ© para reducir carga en la base de datos:
- Las consultas paginadas se almacenan en cachÃ© con clave Ãºnica
- El cachÃ© se invalida automÃ¡ticamente al cancelar citas
- Reduce significativamente el tiempo de respuesta en consultas repetidas

**3. MÃ©tricas con Micrometer**

Cada operaciÃ³n de negocio estÃ¡ instrumentada con `@Timed`:
- `patient.register` - Tiempo de registro de pacientes
- `appointment.schedule` - Tiempo de agendar citas
- `appointment.list.all` - Tiempo de listar todas las citas
- `appointment.list.by.patient` - Tiempo de listar citas por paciente
- `appointment.cancel` - Tiempo de cancelar citas

**4. Endpoints de mÃ©tricas**

**MÃ©tricas generales:**
- `GET /actuator/metrics` - Lista todas las mÃ©tricas disponibles
- `GET /actuator/metrics/{metric.name}` - Detalle de una mÃ©trica especÃ­fica

**Ejemplo:** `GET /actuator/metrics/appointment.schedule`
```json
{
  "name": "appointment.schedule",
  "description": "Time taken to schedule an appointment",
  "measurements": [
    {
      "statistic": "COUNT",
      "value": 150
    },
    {
      "statistic": "TOTAL_TIME",
      "value": 2.5
    },
    {
      "statistic": "MAX",
      "value": 0.125
    }
  ]
}
```

**MÃ©tricas de negocio personalizadas:**
- `GET /api/metrics/business` - EstadÃ­sticas de negocio
  - Total de citas
  - Total de pacientes
  - Promedio de citas por paciente

**Ejemplo de respuesta:**
```json
{
  "total_appointments": 245,
  "total_patients": 87,
  "average_appointments_per_patient": 2.82
}
```

- `GET /api/metrics/performance` - InformaciÃ³n de configuraciÃ³n de rendimiento
  - Estado del cachÃ©
  - Pool de conexiones utilizado
  - Enlaces a endpoints de mÃ©tricas

**5. ExportaciÃ³n a Prometheus**

Para integraciÃ³n con sistemas de monitoreo:
- `GET /actuator/prometheus` - MÃ©tricas en formato Prometheus
  - Compatible con Grafana para dashboards visuales
  - Incluye todas las mÃ©tricas de la aplicaciÃ³n en formato estÃ¡ndar
  - Permite crear alertas basadas en umbrales

---

### CÃ³mo medir el rendimiento

**Con JMeter o Gatling (pruebas de carga):**

1. Realizar 1000 peticiones concurrentes a `/api/appointments`
2. Observar mÃ©tricas en `/actuator/metrics/http.server.requests`
3. Verificar tiempos de respuesta (p95, p99)
4. Confirmar que el cachÃ© reduce el tiempo en consultas repetidas

**Con Prometheus + Grafana (monitoreo en tiempo real):**

1. Configurar Prometheus para scrapear `/actuator/prometheus`
2. Crear dashboard en Grafana con:
   - Tasa de peticiones por segundo
   - Latencia promedio por endpoint
   - Tasa de error (4xx, 5xx)
   - Uso de conexiones del pool
   - Efectividad del cachÃ©

**VerificaciÃ³n rÃ¡pida:**

```bash
# Ver todas las mÃ©tricas HTTP
curl http://localhost:8080/actuator/metrics/http.server.requests

# Ver mÃ©tricas de una operaciÃ³n especÃ­fica
curl http://localhost:8080/actuator/metrics/appointment.schedule

# Ver mÃ©tricas de negocio
curl http://localhost:8080/api/metrics/business

# Ver estado de salud detallado
curl http://localhost:8080/actuator/health
```
### ConclusiÃ³n:

La arquitectura hexagonal es una **inversiÃ³n en el futuro del software**. Aunque requiere mÃ¡s esfuerzo inicial, los beneficios en mantenibilidad, testeabilidad y flexibilidad se hacen evidentes a medida que el proyecto crece. La demo implementada demuestra que es posible aplicar este patrÃ³n en aplicaciones Spring Boot reales, manteniendo la pragmaticidad sin sacrificar los principios arquitectÃ³nicos.

Para aplicaciones empresariales que necesitan **evolucionar, escalar y mantenerse a largo plazo**, la arquitectura hexagonal representa una de las mejores prÃ¡cticas de diseÃ±o disponibles en la industria.

---

[ğŸ  Home](../../../README.md) | [Siguiente â¡ï¸](../0.8.2/0.8.2.md)